<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.hcode.hoj.mapper.ExamProblemMapper">

    <resultMap id="map_ExamProblemList" type="top.hcode.hoj.pojo.vo.ExamProblemVO">
        <id column="id" property="id"></id>
        <result column="content" property="content"></result>
        <result column="type" property="type"></result>
        <result column="difficulty" property="difficulty"></result>
        <result column="analysis" property="analysis"></result>
        <result column="auth" property="auth"></result>
    </resultMap>

    <resultMap id="map_ExamProblemListAdmin" type="top.hcode.hoj.pojo.vo.ExamProblemVO">
        <id column="id" property="id"></id>
        <result column="content" property="content"></result>
        <result column="type" property="type"></result>
        <result column="difficulty" property="difficulty"></result>
        <result column="analysis" property="analysis"></result>
        <result column="auth" property="auth"></result>
        <result column="modified_user" property="modifiedUser"></result>
        <result column="gmt_create" property="gmtCreate"></result>
        <result column="gmt_modified" property="gmtModified"></result>
        <result column="author" property="author"></result>
    </resultMap>

    <resultMap id="map_ExamRepoProblemListAdmin" type="top.hcode.hoj.pojo.vo.ExamRepoProblemVO">
        <id column="id" property="id"></id>
        <result column="content" property="content"></result>
        <result column="type" property="type"></result>
        <result column="difficulty" property="difficulty"></result>
        <result column="analysis" property="analysis"></result>
        <result column="auth" property="auth"></result>
        <result column="modified_user" property="modifiedUser"></result>
        <result column="gmt_create" property="gmtCreate"></result>
        <result column="gmt_modified" property="gmtModified"></result>
        <result column="erp_id" property="erpId"></result>
        <result column="grade" property="grade"></result>
    </resultMap>

    <!-- 主查询 -->
    <select id="getProblemList" resultMap="map_ExamProblemList" useCache="true">
        SELECT DISTINCT ep.id, ep.content, ep.type, ep.difficulty, ep.analysis, ep.auth
        FROM exam_problem ep
        <where>
            <if test="keyword != null and keyword != ''">
                and ep.content like concat('%',#{keyword},'%')
            </if>
            <if test="type != null">
                and ep.type = #{type}
            </if>
            <if test="difficulty != null">
                and ep.difficulty = #{difficulty}
            </if>
            <if test="auth != null">
                and ep.auth = #{auth}
            </if>
            <if test="repoId != null">
                <!-- 子查询，获取匹配 repoId 的 problem_id -->
                and ep.id IN (
                SELECT problem_id
                FROM exam_repo_problem erp
                WHERE erp.repo_id = #{repoId}
                )
            </if>
        </where>

    </select>
    <select id="getProblemListAdmin" resultMap="map_ExamProblemListAdmin" useCache="true">
        SELECT DISTINCT ep.id, ep.content, ep.type, ep.difficulty, ep.analysis, ep.auth, ep.gmt_create, ep.gmt_modified, ep.modified_user, ep.author
        FROM exam_problem ep
        <where>
            <if test="keyword != null and keyword != ''">
                and ep.content like concat('%',#{keyword},'%')
            </if>
            <if test="type != null">
                and ep.type = #{type}
            </if>
            <if test="difficulty != null">
                and ep.difficulty = #{difficulty}
            </if>
            <if test="auth != null">
                and ep.auth = #{auth}
            </if>
            <if test="repoId != null">
                <!-- 子查询，获取匹配 repoId 的 problem_id -->
                and ep.id IN (
                SELECT problem_id
                FROM exam_repo_problem erp
                WHERE erp.repo_id = #{repoId}
                )
            </if>
        </where>
    </select>
    <select id="getProblemListNotInRepo" resultMap="map_ExamProblemListAdmin">
        SELECT DISTINCT ep.id, ep.content, ep.type, ep.difficulty, ep.analysis, ep.auth, ep.gmt_create, ep.gmt_modified, ep.modified_user
        FROM exam_problem ep
        <where>
            <if test="keyword != null and keyword != ''">
                and ep.content like concat('%',#{keyword},'%')
            </if>
            <if test="type != null">
                and ep.type = #{type}
            </if>
            <if test="difficulty != null">
                and ep.difficulty = #{difficulty}
            </if>
            <if test="auth != null">
                and ep.auth = #{auth}
            </if>
            <if test="repoId != null">
                <!-- 子查询，获取匹配 repoId 的 problem_id -->
                and ep.id NOT IN (
                SELECT problem_id
                FROM exam_repo_problem erp
                WHERE erp.repo_id = #{repoId}
                )
            </if>
        </where>
    </select>
    <select id="getProblemListInRepo" resultMap="map_ExamRepoProblemListAdmin">
        SELECT DISTINCT ep.id, ep.content, ep.type, ep.difficulty, ep.analysis, ep.auth, erp.id as erp_id, erp.grade
        FROM exam_problem ep
        LEFT JOIN exam_repo_problem erp
        ON ep.id = erp.problem_id
        <where>
            <if test="repoId != null">
                and erp.repo_id = #{repoId}
            </if>
            <if test="keyword != null and keyword != ''">
                and ep.content like concat('%',#{keyword},'%')
            </if>
            <if test="type != null">
                and ep.type = #{type}
            </if>
            <if test="difficulty != null">
                and ep.difficulty = #{difficulty}
            </if>
            <if test="auth != null">
                and ep.auth = #{auth}
            </if>
        </where>
    </select>
    <select id="getProblemsByRepoId" resultType="top.hcode.hoj.pojo.vo.ExamRepoProblemVO">
        SELECT DISTINCT ep.id, ep.content, ep.type, ep.difficulty, ep.analysis, ep.auth, erp.id as erp_id, erp.grade
        FROM exam_problem ep
        LEFT JOIN exam_repo_problem erp
        ON ep.id = erp.problem_id
        <where>
            <if test="repoId != null">
                and erp.repo_id = #{repoId}
            </if>
        </where>
    </select>


</mapper>
